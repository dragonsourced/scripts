#!/bin/sh

isfeed() {
    for i in "$*"/*; do
        [ -d "$i" ] && echo yes
    done | grep -q yes
}

FEEDS=~/.sfeed/feeds

selfeed() {
    # shellcheck disable=2012
    opt=$(ls | menu -i -p RSS)
    if [ "$opt" ] && [ -d "$opt" ]; then
        FEED="$opt"
        if isfeed "$FEED"; then
            cd "$FEED" || return
            selfeed
        else
            FEED="$PWD/$FEED"
            opts
        fi
    else
        if [ "$PWD" = "$FEEDS" ]; then
            echo "No feed selected. Goodbye!"
            exit
        else
            cd ..
            selfeed
        fi
    fi
}

feed() {
    sort -r "$FEED"/* 2> /dev/null
}

new() {
    feed | sfeed_fmt new author title
}

escape() {
    sed -e 's/\[/\\[/g' -e 's/\]/\\]/g' -e 's|/|\/|g'
}

list() {
    feed | sfeed_fmt author title > /tmp/rss
    new | while read -r line; do
    sed -i "s/^$(echo "$line" | escape)/(new) $(echo "$line" | escape)/g" /tmp/rss
    done
    cat /tmp/rss
    rm /tmp/rss
}

linenum() {
    list | grep -n "$(echo "$*" | escape)" | sed 1q | sed 's/:.*$//'
}

line() {
    n=$1
    feed | sed $((n))q | tail -1
}

sfmt() {
    line="$1"
    shift
    # printf to avoid expanding newlines just yet.
    printf '%s\n' "$line" | sfeed_fmt "$@" 
}

content() {
    sfmt "$*" content | sed -e 's/\\n/\n/g' -e 's/</&lt;/g' -e 's/>/&gt;/g' | sed 15q
}

OPT_AUD="Open in mpv (audio only)"
OPT_YT="Open in mpv"
OPT_WWW="Open in browser"
OPT_CP="Copy link"
OPT_X="[ Cancel ] "

is_media() {
    case "$*" in
        *youtube.com*) true ;;
        *.mp3*|*.m4a*)   true ;;
        *) false ;;
    esac
}

openopts() {
    link="$*"

    is_media "$link" && if [ "$DIPLAY" ]; then
        echo "$OPT_YT"
        echo "$OPT_AUD"
    else
        echo "$OPT_AUD"
        echo "$OPT_YT"
    fi
    echo "$OPT_WWW"
    echo "$OPT_CP"
    echo "$OPT_X"
}

opts() {
    opt="$(list | menu -i -p RSS)"
    [ "$opt" ] || { selfeed; return; }
    num="$(linenum "$opt")"
    line="$(line "$num")"

    link="$(sfmt "$line" enclosure)"
    [ "$link" ] || link="$(sfmt "$line" link)"
    author="$(sfmt "$line" author)"
    content="$(content "$line")"
    echo "$link"
    opt="$(openopts "$link" | menu -i -mesg "$content" -p "$author")"

    if [ "$opt" ]; then
        case "$opt" in
            "$OPT_AUD") mpv --no-video "$link" ;;
            "$OPT_YT") yt "$link" ;;
            "$OPT_WWW") sensible-browser "$link" ;;
            "$OPT_CP") echo "$link" | xsel -b ;;
            *) opts ;;
        esac
    else
        opts
    fi
}

cd "$FEEDS" || exit
selfeed
