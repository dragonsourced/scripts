#!/bin/sh

feedpath=~/.sfeed/feeds

new_of() {
    sfeed_fmt new < "$*" | wc -l
}

new_in() {
    if [ -f "$*" ]; then
        new_of "$*"
    elif [ -d "$*" ]; then
        find "$*" -type f -exec cat '{}' \; | sfeed_fmt new | wc -l
    fi
}

feeds() {
    for f in *; do
        [ -d "$f" ] && f="$f"
        n=$(new_in "$f")
        if [ "$n" -gt 0 ]; then
            echo "$f ($n new)"
        else
            echo "$f"
        fi
    done
}

strip_new() {
    echo "$*" | sed 's/ ([0-9 ]*new)$//'
}

entries() {
    n=$(new_of "$*")
    i=0
    sfeed_fmt title < "$*" | while read -r e; do
        if [ $i -lt "$n" ]; then
            echo "$e (new)"
        else
            echo "$e"
        fi
        i=$((i+1))
    done
}

view_entry() {
    echo "$*"
}

view_feed() {
    feed="$*"
    n=$(new_of "$feed")
    a=""
    [ "$n" -gt 0 ] && a="-a $(seq -s , 0 $((n-1)))"
    # shellcheck disable=2086
    entry=$(entries "$feed" | menu $a -i -p "$feed")
    view_entry "$entry"
}

selfeed() {
    p="RSS"
    [ "$PWD" != $feedpath ] && p="$(basename "$PWD")"
    opt="$(feeds | menu -i -p "$p")"
    opt=$(strip_new "$opt")
    if [ -d "$opt" ]; then
        cd "$opt" || return
        selfeed
    elif [ -f "$opt" ]; then
        view_feed "$opt"
        selfeed
    elif [ "$PWD" = $feedpath ]; then
        exit
    else
        cd ..
        selfeed
    fi
}

cd $feedpath || exit
selfeed
